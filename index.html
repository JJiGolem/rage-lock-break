<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>Rage lock break</title>
</head>

<body>
  <div class="lock">
    <div class="keyhole_main">
      <img id="keyhole" src="./images/keyhole.png" alt="keyhole">
      <img id="lockpick" src="./images/lockpick.png" alt="screwdriver">
    </div>
  </div>
  <div class="help_about_control">
    <div class="help_element">
      <span>A / D</span>
      –ü–æ–≤–µ—Ä–Ω—É—Ç—å –∑–∞–º–æ–∫
    </div>
    <div class="help_element">
      <span>‚Üê üñ± ‚Üí</span>
      –ü–æ–≤–µ—Ä–Ω—É—Ç—å –æ—Ç–º—ã—á–∫—É
    </div>
  </div>

  <script src="./js/utils.js"></script>
  <script src="./js/keyhole.js"></script>
  <script src="./js/lockpick.js"></script>
  <script src="./js/fpscontrol.js"></script>
  <script>
    let pressedKey = null;
    let cooldown = null;
    let keyupFreeze = false;
    let keydownFreeze = false;
    let mousemoveFreeze = false;

    keyholeInit();
    lockpickInit();

    const fps = new FpsControl(30, (e) => {
      animate();
    });

    fps.start();

    window.addEventListener("keydown", (evt) => {
      if (keydownFreeze) {
        return;
      }

      if ([68, 65].includes(evt.keyCode) && !cooldown) {
        pressedKey = evt.keyCode;
      } else {
        pressedKey = null;
      }
    })

    window.addEventListener("keyup", (evt) => {
      if (keyupFreeze) {
        return;
      }

      pressedKey = null;
    })

    window.addEventListener("mousemove", (evt) => {
      if (mousemoveFreeze) {
        return;
      }

      rotateLockpick(evt);
    })

    function animate() {
      rotateKeyhole();
      keyhole.style.transform = "rotateZ(" + keyholeRotation + "deg)";
      lockpick.style.transform = "translate(-100%, -100%) rotateZ(" + lockpickRotation + "deg)";
    }

    function stopAnimate() {
      fps.pause();
    }

    function disablePressedKey() {
      pressedKey = null;
      startCooldown();
    }

    function freezeAll() {
      keydownFreeze = true;
      keyupFreeze = true;
      mousemoveFreeze = true;
    }

    function startCooldown() {
      cooldown = setTimeout(() => {
        clearTimeout(cooldown);
        cooldown = null;
      }, 100);
    }

    function restart() {
      pressedKey = null;
      keyupFreeze = false;
      keydownFreeze = false;
      mousemoveFreeze = false;
      keyholeRotation = 0;
      lockpickRotation = 0;
      keyholeInit();
      lockpickInit();
      
      if (!fps.isPlaying) {
        fps.start();
      }
    }
  </script>
</body>

</html>